---
title: "Substitution Summary Report"
output:
  word_document:
    highlight: null
    pandoc_args:
      - "--dpi=72"
      - "--syntax-highlighting=tango"
params:
  input_json: NULL
  preview_dir: NULL
  images_dir: NULL
  pdftools_available: FALSE
---

```{r init_chunk, include=FALSE}
suppressPackageStartupMessages({
  library(jsonlite)
  library(dplyr)
  library(purrr)
  library(tidyr)
  library(stringr)
  library(glue)
  library(knitr)
})

`%||%` <- function(x, y) {
  if (is.null(x) || length(x) == 0) y else x
}

if (is.null(params$input_json)) {
  stop("params$input_json must point to the Python summary JSON file.")
}

summary_data <- fromJSON(params$input_json, simplifyVector = FALSE)
preview_dir <- params$preview_dir %||% file.path(tempdir(), "pdf_previews")
dir.create(preview_dir, recursive = TRUE, showWarnings = FALSE)

# Use per-run images directory (passed from render_report.sh) and fall back to local images/
rmd_dir <- dirname(knitr::current_input(dir = TRUE))
if (is.null(rmd_dir) || !nzchar(rmd_dir)) {
  rmd_dir <- getwd()
}
images_dir <- params$images_dir %||% file.path(rmd_dir, "images")
dir.create(images_dir, recursive = TRUE, showWarnings = FALSE)
images_rel_base <- file.path("images", basename(images_dir))

has_pdftools <- isTRUE(params$pdftools_available)
if (has_pdftools) {
  suppressPackageStartupMessages(library(pdftools))
}

render_pdf_preview <- function(pdf_path, preview_dir, images_dir, dpi = 200) {
  if (!has_pdftools) {
    return(NULL)
  }

  if (!file.exists(pdf_path)) {
    return(NULL)
  }

  hash <- unname(tools::md5sum(pdf_path))
  preview_template <- file.path(preview_dir, paste0(hash, "-%d.%s"))
  first_page_path <- sprintf(preview_template, 1, "png")

  if (!file.exists(first_page_path)) {
    tryCatch(
      {
        suppressWarnings({
          capture.output(
            {
              capture.output(
                pdftools::pdf_convert(
                  pdf = pdf_path,
                  format = "png",
                  pages = 1,
                  dpi = dpi,
                  filenames = preview_template
                ),
                file = NULL,
                type = "message"
              )
            },
            file = NULL
          )
        })
      },
      error = function(e) {
        message(sprintf("Warning: failed to render preview for %s (%s)", pdf_path, e$message))
      }
    )
  }

  if (!file.exists(first_page_path)) {
    message(sprintf("Preview file not found: %s (template: %s)", first_page_path, preview_template))
    NULL
  } else {
    preview_abs <- normalizePath(first_page_path, mustWork = TRUE)
    preview_basename <- basename(preview_abs)
    dest_path <- file.path(images_dir, preview_basename)
    if (!file.exists(dest_path)) {
      file.copy(preview_abs, dest_path, overwrite = FALSE)
    }
    dest_path
  }
}
```

```{r issues_chunk, echo=FALSE, results='asis'}
if (length(summary_data$issues) > 0) {
  cat("## Warnings\n\n")
  cat(paste0("- ", summary_data$issues, collapse = "\n"), "\n\n")
}
```

```{r report_chunk, echo=FALSE, results='asis'}
if (length(summary_data$datasets) == 0) {
  cat("Dataset not found.\n")
} else {
  walk(summary_data$datasets, function(ds) {
    cat(glue("## Dataset: {ds$dataset}\n\n"))
    cat(glue("- Latest run: `{ds$latest_run %||% 'N/A'}`  \n"))
    cat(glue("- Run directory: `{ds$run_dir %||% 'N/A'}`\n\n"))

    species_tbl <- tibble(
      species_label = c("Species B", "Species C"),
      accession = c(
        ds$species2$accession %||% NA_character_,
        ds$species3$accession %||% NA_character_
      ),
      organism = c(
        ds$species2$ncbi_lookup$species_name %||% NA_character_,
        ds$species3$ncbi_lookup$species_name %||% NA_character_
      ),
      percent_identity = c(
        str_remove(ds$species2$train_identity_line %||% NA_character_, "^# substitution percent identity:\\s*"),
        str_remove(ds$species3$train_identity_line %||% NA_character_, "^# substitution percent identity:\\s*")
      ),
      substitution_ratio = c(
        ds$species2$sbst_ratio_entry %||% NA_character_,
        ds$species3$sbst_ratio_entry %||% NA_character_
      ),
      gc_content = c(
        paste(ds$species2$gc_content %||% "", collapse = "\n"),
        paste(ds$species3$gc_content %||% "", collapse = "\n")
      )
    ) %>%
      replace_na(
        list(
          accession = "(missing)",
          organism = "(missing)",
          percent_identity = "(missing)",
          substitution_ratio = "(missing)",
          gc_content = "(missing)"
        )
      )

    print(
      kable(
        species_tbl,
        col.names = c("Species", "Accession", "Organism", "Percent Identity", "Substitution Ratio", "GC Content")
      )
    )
    cat("\n")

    species_list <- list(
      list(data = ds$species2, label = "Species B"),
      list(data = ds$species3, label = "Species C")
    )

    walk(species_list, function(entry) {
      species <- entry$data
      label <- entry$label

      cat(glue("### {label}\n\n"))

      if (!is.null(species$ncbi_lookup$stderr) && nzchar(species$ncbi_lookup$stderr)) {
        cat(glue("> NCBI CLI notice: {species$ncbi_lookup$stderr}\n\n"))
      }

      if (!is.null(species$gc_content_file)) {
        cat(glue("GC content file: `{species$gc_content_file}`\n\n"))
      }

      cat("#### PDF Artifacts\n\n")
      iwalk(species$pdfs, function(paths, pdf_key) {
        nice_label <- pdf_key %>%
          str_replace_all("_", " ") %>%
          str_to_title()

        if (length(paths) == 0) {
          cat(glue("\n\n**{nice_label}** (not found)\n\n"))
        } else {
          cat(glue("\n\n**{nice_label}**\n\n"))
          walk(paths, function(pdf_path) {
            cat(glue("File: `{pdf_path}`\n\n"))
            preview <- render_pdf_preview(pdf_path, preview_dir, images_dir)
            if (!is.null(preview)) {
              preview_rel <- file.path(images_rel_base, basename(preview))
              cat(glue("\n![]({preview_rel}){{width=16.5cm}}\n\n"))
            } else {
              cat("(Failed to generate preview)\n\n")
            }
          })
        }
      })

      cat("\n")
    })
  })
}

```

